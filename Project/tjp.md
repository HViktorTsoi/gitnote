# Note
## hdl localization
1. IMU LiDAR 外参标定

## LIO localization
跑Dan Hai的定位算法
1. 方案1: 
   1. 忽略odom to map的估计
   2. 直接把global initialization作为map optimization的起始odometry
   3. 在每次全局定位之后, 把全局transform作为gps factor, 加入因子图进行优化
2. 方案2:
   1. 维护odom to map;
   2. 每次全局定位只有, 把全局transform作为gps factor, 加入因子图进行优化. (验证是不是要把全局定位转换到odometry系再加到因子图中)

# multilidar localization
1. 维护一个单独的imu preintegration不变
2. 更改msg形式，使其存储每个LiDAR的id
3. 对于每个lidar，单独使用image projection和feature extraction
4. 在image projection中，维护LiDAR数量的imuQ，将imu对齐到不同的LiDAR系下
5. 在graphLocalization中，用外参将每个LiDAR的特征经过时间同步之后融合在一起，然后进行scan2map的里程计估算以及全局定位
6. 对于2和5，第二种方式是在image projection收到每个LiDAR之后，直接全都转换到base lidar的坐标系下，这样imu deskew等维持原样就可以
7. 考虑像DC一样，因子图中每个节点的状态除了位姿之外，还要有lidar的外参

DC Loam Livox中的方案：
1. 在提特征的部分维护一个subscriber列表， 订阅多路原始点云；
2. 对每一路原始点云提取特征（局部坐标系的），标记相应的lidar id之后发布出去；
3. 在mapping过程中，接受每个lidar单独的特征（局部坐标系的），用事先标定好的外参将特征统一到主lidar系下，再进行后续的过程
4. DCloamlivox维护一个42状态的EKF，分别是3轴R, 3轴T, 3轴w, 3轴v， 和5个LiDAR的6dof外参，在slam过程中同时估计这些量


## 开发日志
1. lio localization中, 用滑动窗口win来保存待全局匹配的关键帧, 并且没有保存关键帧id, 如果在全局定位之后直接用win的size来作为因子图节点的ID, 那么这个ID就会是错误的, 在超过滑动窗口大小之后, ID就一直是那个窗口最大长度了
2. 在全局定位之后, 求odom测量值时, 旧的odom2map的tf不一定与关键帧是对应的,这里需要再确定一下
3. 尝试了只使用初始的map to odom(后续不更新), 这和将odom的第一帧设置为map中的绝对位姿是一致的, 结果发现,轨迹确实不会有跳变了, 但是变成低频的凸起了, 这可能说明全局定位的观测量就是不准的
4. reply速度对性能也有影响, 实验发现mapping的速度总会落后odometry几帧 **这是因为我开发的时候关闭了keypose的滑动窗口,现在每次回环检测都要遍历所有的滑动窗口, 待修复**
5. 飞了的情况应该是mapping测量得到的相对距离比imu预积分得到的距离大了, 导致优化出来的ba比实际的大很多, 在后续的积分上,用一个特别大的ba去积分, 当然位姿就飞了
6. 优化之后odometry还是很平滑的， 我们看到的跳变是map to odom 造成的
7. 思考， 为什么用lio relocalization的原始形式， 得到的轨迹不是平滑的？
   1. 如果优化odom to map， 则这个硬性的定时优化当然会影响平滑性
   2. 如果只优化odom， 为什么会轨迹会慢慢远离map？ 第一个因子是0， 在计算的时候转换到map， 与第一个因子是odom2map的区别是什么？？？
8. 我们需要全局轨迹优化吗？ 全局匹配的效果很好， lio的累计误差也不大，是不是不需要优化太久之前的轨迹？？？
9. 一个重要的问题， odometry factor都是用自己构建的local得到的， 而全局定位是根据全局匹配得到的，这样就有个严重的问题：
   1.  当里程计和地图偏差不大的时候， 建出来的地图很平滑
   2.  当里程计和地图偏差很大时， 由于里程计因子的数量很多（且方差很小），地图定位因子的数量很少（且方差很大），最后全局定位无法将里程计拉回来，表现为全局定位时震荡很大，两次定位期间轨迹很平滑但是与地图偏差较大

10. 尝试用map to odom更新起始点坐标（这个只有在odom与轨迹误差是线性的时候好用，即odom累计误差很小的时候）
11. 最后发现确实是线程同步的bug， 访问全局配准关键帧的odom是在全局配准之后，整整和对应关键帧差了1秒（就这样还跑了个八九不离十）；然后发现，全局配准的时刻与当前帧越近，配准的平滑性越好
12. 尝试同时优化imu LiDAR的外参？
13. TODO: 仅保留小的滑动窗口
14. 取消点云运动畸变消除之后， local map的累计误差明显减小了， 此时里程计和地图更一致，这说明IMU和雷达的外参对建图性能影响还是不小的
15. 在之前的实现中， LIOSAM内置一个imu预积分更新的flag，当发生回环或者加入gps时，imu预计分是不更新的，这样可以防止地图更正的跳变（实际上base没有发生这样的运动）导致imu更新出错误的，非常大的ba和bg。
16. 之前在全局定位之后的时候没有更新内存中的关键帧位姿、、、、、、 只有isam里保存了，因此mapping的时候用的还是老的位姿；用的局部地图也是老的位姿，这里非常关键！！！！！！！ **局部地图一定要实时更新，这样才能保证里程计偏的不多**
17. TODO 解决初始化过程中IMU不稳定造成的问题
18. LIOSAM中，odometry-incremental是累计里程计； IMU要使用初始值为0的里程计来初始化，否则会造成初始ba bg优化值的不稳定，会有非常大的跳变
19. 局部地图和全局地图不一致，目前来看这是对的，因为这是因子图修正之后，后端认为局部地图应该有的空间结构，所以可以看出来此时的定位是准确的
20. 将旧的pose全部marginlize之后，结果确实更平滑了，原来跳变的部分变为较为平滑的过渡
21. marginalization必须遵循一定的顺序
22. 添加prior之后再进行marginalization，有可能出现本来是父节点的变量变为子节点，此时如果还是按照原始顺序来margin， 可能把父节点当做叶节点给margin掉了（这个父节点的所有叶子节点会被删除，但是父节点保留（这里待确认）），后边如果再margin原来的那个父节点，就会出现segmentation fault（因为已经被margin掉了）
23. 第二种情况是，添加的先验变量与普通变量连接到同一个父节点上了， isam的marginlize对于这样的情况处理的不正常
24. 经过profile发现，最占用时间的是全局定位和scan2mapoptimization，后端优化的部分只占特别小的一部分，其中marginalization更小
25. 对于杭研院数据集，在interactive slam建图之前，需要关闭liosam的回环检测，并将所有的地面都设置为ground，最后定位没有太大的偏差
26. 是超时的影响？？？？？？？？是超时的影响！！！！！！！！！！！！！！！！！！！！！！！
27. **在isam中，如果后加入的多元因子P（图中已经有一个与P有关的变量了）与当前最新因子的ID（加入时间）差距太远（实际测试表明是相差>=3），贝叶斯树会将P对应的节点转换为一个没有子树的独立的叶子节点，这时如果将P这个独立的叶子节点margin掉会出现严重的bug，即isam自带的marginalization无法删除这个叶子节点，最后这颗树就会出现孤立节点，在update时就会出现out_of_range或者invalid argument错误。**
28. 解决办法：
    1.  将ID相差>=3的全局定位约束直接扔掉，这种情况仅发生在全局定位消耗了过长的时间，因此是偶然发生的，不会严重影响全局定位性能。除非平台性能差，每次全局定位消耗的时间都超过了3个新关键帧的产生时间，这种情况下全局定位约束就会经常丢失
    2.  利用全局定位关键帧-当前最新关键帧的相对里程计，将全局定位转换到当前关键帧对应的坐标系下，这样可以保证约束的时序，但是定位对应帧到当前帧的累计误差会混淆到全局定位信息里，这会不会影响全局定位性能还需要进一步测试
    3.  修改gtsam的某个阈值，使得重构bayes树的间隔增大，这样即使全局定位慢导致定位约束因子滞后，也不会使得贝叶斯树重构成有bug的形式

29. hdl_localization的一系列包会对正常的package查找openmp有影响
30. TODO map localization丢失之后增大odometry滑动窗口大小
